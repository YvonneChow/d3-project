$(document).ready(function(){function t(t){d3.csv("assets/data/Patient"+t+".csv",function(t,v){function m(t){}function x(){var t=R.attr("width"),a=Math.max(n(c("6:30:00 AM"))+e.left,Math.min(parseInt(R.attr("x"))+parseInt(t),d3.event.x));t=parseInt(t)+parseInt(R.attr("x"))-parseInt(a),j.attr("x1",a).attr("x2",a),R.attr("x",a).attr("width",t)}function V(){var t=R.attr("width"),a=Math.max(R.attr("x"),Math.min(n(c("11:00:00 AM"))+e.left,d3.event.x));t=a-R.attr("x"),E.attr("x1",a).attr("x2",a),R.attr("width",t)}function G(){_.attr("cx",function(){return xTopGraphScale(brush.extent()[0])+1}),tt.attr("cx",function(){return xTopGraphScale(brush.extent()[1])-1}),d3.selectAll(".sidebar").remove(),d3.selectAll(".text-percentage").remove(),d3.selectAll(".line-group").remove(),d3.selectAll(".hollow").remove(),d3.selectAll(".last-line").remove(),d3.selectAll(".last-dot").remove(),$(".tooltip-last-day").remove(),B()}function B(){for(var t,i,p=0,v=T.length-1,m=0,x=k.length-1,V=0;V<T.length;V++)if(""!=T[V].Date&&Q(T[V].Date).getTime()>=brush.extent()[0].getTime()){p=V;break}for(var V=T.length-1;V>=0;V--)if(""!=T[V].Date&&Q(T[V].Date).getTime()<=brush.extent()[1].getTime()){v=V;break}t=T.slice(p,v+1);for(var V=0;V<k.length;V++){if(Q(k[V].Date).getTime()>=brush.extent()[0].getTime()){m=V;break}m=0}for(var V=k.length-1;V>=0;V--){if(Q(k[V].Date).getTime()<=brush.extent()[1].getTime()){x=V;break}x=0}i=k.slice(m,x+1),console.log(k),I[0].value=0,I[1].value=0,I[2].value=0,I[3].value=0,I[4].value=0;for(var V=0;V<t.length;V++)parseInt(t[V].BGValue)<70&&I[0].value++,parseInt(t[V].BGValue)>=70&&parseInt(t[V].BGValue)<=180&&I[1].value++,parseInt(t[V].BGValue)>300&&I[4].value++,parseInt(t[V].BGValue)>250&&I[3].value++,parseInt(t[V].BGValue)>180&&I[2].value++;var G;G=A>300?[{color:u,height:r-s(70),yStart:e.top+s(70),value:I[0].value/t.length},{color:h,height:s(70)-s(180),yStart:e.top+s(180),value:I[1].value/t.length},{color:d,height:s(180),yStart:e.top,value:I[2].value/t.length},{color:g,height:s(250),yStart:e.top,value:I[3].value/t.length},{color:f,height:s(300)-s(A),yStart:e.top,value:I[4].value/t.length}]:300>=A&&A>250?[{color:u,height:r-s(70),yStart:e.top+s(70),value:I[0].value/t.length},{color:h,height:s(70)-s(180),yStart:e.top+s(180),value:I[1].value/t.length},{color:d,height:s(180),yStart:e.top,value:I[2].value/t.length},{color:g,height:s(250)-s(A),yStart:e.top,value:I[3].value/t.length}]:250>=A&&A>180?[{color:u,height:r-s(70),yStart:e.top+s(70),value:I[0].value/t.length},{color:h,height:s(70)-s(180),yStart:e.top+s(180),value:I[1].value/t.length},{color:d,height:s(180)-s(A),yStart:e.top,value:I[2].value/t.length}]:180>=A&&A>70?[{color:u,height:r-s(70),yStart:e.top+s(70),value:I[0].value/t.length},{color:h,height:s(70)-s(180),yStart:e.top,value:I[1].value/t.length}]:[{color:u,height:r-s(70),yStart:e.top,value:I[0].value/t.length}],l.selectAll("rect.sidebar").data(G).enter().append("rect").attr("class","sidebar").attr("x",function(t){return e.left+a}).attr("y",function(t){return t.yStart}).attr("width",function(t){return 100*t.value<10&&100*t.value>0?t.value+10:100*t.value}).attr("height",function(t){return t.height}).attr("fill",function(t){return t.color});for(var V=0;V<I.length;V++)I[V].value=(I[V].value/t.length*100).toFixed(2),I[V].value>0&&l.append("text").attr("class","text-percentage").text(I[V].value+"% "+I[V].category).attr("x",a+e.left+10).attr("y",e.top+20*(5-V)).attr("fill","#000000");var B=l.selectAll(".hollow").data(t).enter().append("circle").attr("class","hollow");B.attr("cx",function(t,a){return n(c(t.Time))+e.left}).attr("cy",function(t,a){return s(t.BGValue)+e.top}).attr("r",function(t,e){return"0"==t.Used?5:void 0}).attr("fill",function(t,e){return"0"==t.Used?"#ffffff":void 0}).attr("opacity",.5).attr("stroke",function(t,e){return"0"==t.Used?parseInt(t.BGValue)<70?u:parseInt(t.BGValue)>=70&&parseInt(t.BGValue)<=180?h:parseInt(t.BGValue)>180&&parseInt(t.BGValue)<=250?d:parseInt(t.BGValue)>250&&parseInt(t.BGValue)<=300?g:f:void 0}).attr("stroke-width",function(t,e){return"0"==t.Used?3:void 0}).on("mouseover",function(t,a){d3.selectAll(".hollow").attr("opacity",.1),d3.select(this).transition().ease("elastic").duration("500").attr("r",10).attr("opacity",1),d3.selectAll(".line-group").attr("opacity",.3),o.transition().duration(200).style("opacity",1),o.html("<strong>Date: </strong>"+t.Date+"<br/><strong>Time: </strong>"+t.Time+"<br/><strong>Type: </strong>"+t.Type+"<br/><strong>BG Value: </strong>"+t.BGValue).style("left",n(c(t.Time))+e.left-.5*$(".tooltip").width()-12+"px").style("top",s(t.BGValue)-5+"px"),$(".tooltip-last-day").css({opacity:0})}).on("mouseout",function(t,e){d3.select(this).transition().ease("elastic").duration("500").attr("r",5).attr("opacity",.5),d3.selectAll(".line-group").attr("opacity",1),d3.selectAll(".hollow").attr("opacity",.5),o.transition().duration(200).style("opacity",0).duration(200).style("left",0).style("top",0),$(".tooltip-last-day").css({opacity:1})});var b=d3.svg.line().x(function(t){return n(c(t.Time))}).y(function(t){return s(t.BGValue)});if(0!=x)var D=l.selectAll(".line-group").data(i).enter().append("g").attr("class","line-group").on("mouseover",function(){d3.select(this).selectAll("path").transition().ease("elastic").duration("500").attr("opacity","1").attr("stroke-width","8"),d3.selectAll(".hollow").attr("opacity",.1),d3.selectAll(".dot").attr("opacity",.1),d3.select(this).selectAll(".dot").transition().ease("elastic").duration("500").attr("r","10").attr("opacity",1)}).on("mouseout",function(){d3.select(this).selectAll("path").transition().ease("elastic").duration("500").attr("opacity","0.2").attr("stroke-width","3"),d3.selectAll(".hollow").attr("opacity",.5),d3.selectAll(".dot").attr("opacity",.5),d3.select(this).selectAll(".dot").transition().ease("elastic").duration("500").attr("r","6").attr("opacity",.5)}),w=D.append("path").attr("d",function(t){return b(t.Value)}).attr("transform","translate("+e.left+","+e.top+")").attr("stroke",y).attr("stroke-width",3).attr("fill","none").attr("opacity","0.2"),S=D.append("g").selectAll(".dot").data(function(t){return t.Value}).enter().append("circle").attr("cx",function(t,a){return n(c(t.Time))+e.left}).attr("cy",function(t,a){return s(t.BGValue)+e.top}).attr("r","6").attr("fill",function(t,e){return parseInt(t.BGValue)<70?u:parseInt(t.BGValue)>=70&&parseInt(t.BGValue)<=180?h:parseInt(t.BGValue)>180&&parseInt(t.BGValue)<=250?d:parseInt(t.BGValue)>250&&parseInt(t.BGValue)<=300?g:f}).attr("opacity",.5).attr("class","dot").on("mouseover",function(t,a){o.transition().duration(200).style("opacity",1),o.html("<strong>Date: </strong>"+t.Date+"<br/><strong>Time: </strong>"+t.Time+"<br/><strong>Type: </strong>"+t.Type+"<br/><strong>BG Value: </strong>"+t.BGValue).style("left",n(c(t.Time))+e.left-.5*$(".tooltip").width()-12+"px").style("top",s(t.BGValue)-5+"px"),$(".tooltip-last-day").css({opacity:0})}).on("mouseout",function(t,e){o.transition().duration(200).style("opacity",0).duration(200).style("left",0).style("top",0),$(".tooltip-last-day").css({opacity:1})});if(i[i.length-1].Date==k[k.length-1].Date){console.log(k[k.length-1]);var M=l.append("path").attr("d",function(t){return b(k[k.length-1].Value)}).attr("transform","translate("+e.left+","+e.top+")").attr("stroke",y).attr("fill","none").attr("opacity","1").attr("stroke-width","8").attr("class","last-line"),U=l.selectAll(".last-dot").data(k[k.length-1].Value).enter().append("circle").attr("cx",function(t,a){return n(c(t.Time))+e.left}).attr("cy",function(t,a){return s(t.BGValue)+e.top}).attr("r","10").attr("fill",function(t,e){return parseInt(t.BGValue)<70?u:parseInt(t.BGValue)>=70&&parseInt(t.BGValue)<=180?h:parseInt(t.BGValue)>180&&parseInt(t.BGValue)<=250?d:parseInt(t.BGValue)>250&&parseInt(t.BGValue)<=300?g:f}).attr("opacity",1).attr("class","last-dot").on("mouseover",function(t,a){d3.selectAll(".hollow").attr("opacity",.1),d3.selectAll(".line-group").attr("opacity",.3),o.transition().duration(200).style("opacity",1),o.html("<strong>Date: </strong>"+t.Date+"<br/><strong>Time: </strong>"+t.Time+"<br/><strong>Type: </strong>"+t.Type+"<br/><strong>BG Value: </strong>"+t.BGValue).style("left",n(c(t.Time))+e.left-.5*$(".tooltip").width()-12+"px").style("top",s(t.BGValue)-5+"px"),$(".tooltip-last-day").css({opacity:0})}).on("mouseout",function(t,e){d3.selectAll(".line-group").attr("opacity",1),d3.selectAll(".hollow").attr("opacity",.5),o.transition().duration(200).style("opacity",0).duration(200).style("left",0).style("top",0),$(".tooltip-last-day").css({opacity:1})}),C=d3.select("#svg").append("div").attr("class","tooltip tooltip-last-day"),P=k[k.length-1].Value.length-1;C.html("<strong>Date: </strong>"+k[k.length-1].Date+"<br/><strong>Time: </strong>"+k[k.length-1].Value[P].Time+"<br/><strong>Type: </strong>"+k[k.length-1].Value[P].Type+"<br/><strong>BG Value: </strong>"+k[k.length-1].Value[P].BGValue).style("left",n(c(k[k.length-1].Value[P].Time))+e.left-48-12+"px").style("top",s(k[k.length-1].Value[P].BGValue)-5+"px").style("opacity",1)}}for(var T=[],b=0,A=0,I=[{category:"HYPO < 70",value:0},{category:"70-180",value:0},{category:"HYPO > 180",value:0},{category:"HYPO > 250",value:0},{category:"HYPO > 300",value:0}],D=0;D<v.length;D++)A<parseInt(v[D].BGValue)&&(A=parseInt(v[D].BGValue)),parseInt(v[D].BGValue)<70&&I[0].value++,parseInt(v[D].BGValue)>=70&&parseInt(v[D].BGValue)<=180&&I[1].value++,parseInt(v[D].BGValue)>300&&I[4].value++,parseInt(v[D].BGValue)>250&&I[3].value++,parseInt(v[D].BGValue)>180&&I[2].value++,T.push({id:v[D].id,Date:v[D].Date,Time:v[D].Time,BGValue:v[D].BGValue,Comment:v[D].Comment,Type:v[D].Type,Used:v[D].Used});console.log(T),A=10*Math.ceil(A/10),n=d3.time.scale().domain([c("12:00:00 AM"),c("11:59:59 PM")]).range([0,a]),i=d3.svg.axis().scale(n).orient("bottom").tickFormat(d3.time.format("%I:%M %p")),s=d3.scale.linear().domain([b,A]).rangeRound([r,0]),p=d3.svg.axis().scale(s).orient("left");for(var k=[],w=[],S=0,M=0,U=0,D=0;D<T.length;D++){M=0;for(var C=0;C<w.length;C++)w[C].Date==T[D].Date&&(M++,w[C].Value.push({id:T[D].id,Time:T[D].Time,BGValue:T[D].BGValue,Comment:T[D].Comment,Type:T[D].Type,Used:T[D].Used,Date:T[D].Date}));if(0==M){var P=[];P.push({id:T[D].id,Time:T[D].Time,BGValue:T[D].BGValue,Comment:T[D].Comment,Type:T[D].Type,Used:T[D].Used,Date:T[D].Date}),w.push({Date:T[D].Date,Value:P,AverageBGValue:0})}if("1"==T[D].Used){S=0;for(var C=0;C<k.length;C++)k[C].Date==T[D].Date&&(S++,k[C].Value.push({id:T[D].id,Time:T[D].Time,BGValue:T[D].BGValue,Comment:T[D].Comment,Type:T[D].Type,Used:T[D].Used,Date:T[D].Date}));if(0==S){var P=[];P.push({id:T[D].id,Time:T[D].Time,BGValue:T[D].BGValue,Comment:T[D].Comment,Type:T[D].Type,Used:T[D].Used,Date:T[D].Date}),k.push({Date:T[D].Date,Value:P,AverageBGValue:0})}}}""==w[w.length-1].Date&&w.pop();var z=[];z=A>300?[{color:"#e8e9ea",height:r-s(A)},{color:"#eceded",height:r-s(300)},{color:"#f1f2f2",height:r-s(250)},{color:"#f4f4f5",height:r-s(180)},{color:"#f1f2f2",height:r-s(70)},{color:"#eceded",height:r-s(60)},{color:"#e4e5e6",height:r-s(40)}]:300>=A&&A>250?[{color:"#eceded",height:r-s(A)},{color:"#f1f2f2",height:r-s(250)},{color:"#f4f4f5",height:r-s(180)},{color:"#f1f2f2",height:r-s(70)},{color:"#eceded",height:r-s(60)},{color:"#e4e5e6",height:r-s(40)}]:250>=A&&A>180?[{color:"#f1f2f2",height:r-s(A)},{color:"#f4f4f5",height:r-s(180)},{color:"#f1f2f2",height:r-s(70)},{color:"#eceded",height:r-s(60)},{color:"#e4e5e6",height:r-s(40)}]:180>=A&&A>70?[{color:"#f4f4f5",height:r-s(A)},{color:"#f1f2f2",height:r-s(70)},{color:"#eceded",height:r-s(60)},{color:"#e4e5e6",height:r-s(40)}]:70>=A&&A>60?[{color:"#f1f2f2",height:r-s(A)},{color:"#eceded",height:r-s(60)},{color:"#e4e5e6",height:r-s(40)}]:60>=A&&A>40?[{color:"#eceded",height:r-s(A)},{color:"#e4e5e6",height:r-s(40)}]:[{color:"#e4e5e6",height:r-s(A)}];var H=l.selectAll(".background-group").data(z).enter().append("rect").attr("width",a).attr("height",function(t,e){return t.height}).attr("fill",function(t,e){return t.color}).attr("transform",function(t,a){return"translate("+e.left+","+(r+e.top-t.height)+")"}),O=d3.behavior.drag().on("drag",V),Y=d3.behavior.drag().on("drag",x),F=l.append("g").attr("class","rect-breakfast"),R=F.append("rect").attr("height",r).attr("width",function(t,e){return n(c("10:00:00 AM"))-n(c("8:30:00 AM"))}).attr("fill","#ffffff").attr("fill-opacity","0.6").attr("y",e.top).attr("x",n(c("8:30:00 AM"))+e.left),L=F.append("g").attr("class","draglineleft").call(Y),j=L.append("line").attr("x1",n(c("8:30:00 AM"))+e.left).attr("y1",e.top).attr("x2",n(c("8:30:00 AM"))+e.left).attr("y2",r+e.top).attr("stroke-width",2).attr("stroke","#4AA5B8").attr("cursor","ew-resize"),q=F.append("g").attr("class","draglineright").call(O),E=q.append("line").attr("x1",n(c("10:00:00 AM"))+e.left).attr("y1",e.top).attr("x2",n(c("10:00:00 AM"))+e.left).attr("y2",r+e.top).attr("stroke-width",2).attr("stroke","#4AA5B8").attr("cursor","ew-resize");l.append("line").attr("x1",e.left+a).attr("y1",r+e.top).attr("x2",e.left+a).attr("y2",e.top).attr("stroke-width",3).attr("stroke","#babcbf"),l.append("line").attr("x1",e.left).attr("y1",e.top).attr("x2",e.left+a).attr("y2",e.top).attr("stroke-width",3).attr("stroke","#babcbf"),l.append("line").attr("x1",e.left).attr("y1",s(70)+e.top).attr("x2",e.left+a).attr("y2",s(70)+e.top).attr("stroke-width",2).attr("stroke","#b2d1dc").style("stroke-dasharray","3, 3"),l.append("line").attr("x1",e.left).attr("y1",s(180)+e.top).attr("x2",e.left+a).attr("y2",s(180)+e.top).attr("stroke-width",2).attr("stroke","#b2d1dc").style("stroke-dasharray","3, 3"),l.append("g").attr("class","axis").attr("transform","translate("+e.left+","+(r+e.top)+")").transition().duration(500).call(i),l.append("g").attr("class","axis").attr("transform","translate("+e.left+","+e.top+")").transition().duration(500).call(p),l.append("text").text("Breakfast").attr("x",n(c("8:30:00 AM"))+e.left).attr("y",e.top+20).attr("fill","#939496"),l.append("text").text("Lunch").attr("x",n(c("12:00:00 PM"))+e.left+10).attr("y",e.top+20).attr("fill","#939496"),l.append("text").text("Dinner").attr("x",n(c("5:30:00 PM"))+e.left+20).attr("y",e.top+20).attr("fill","#939496");for(var J=0,K=0,N=0,D=0;D<w.length;D++){N=0;for(var C=0;C<w[D].Value.length;C++)"0"!=w[D].Value[C].Used?K+=parseInt(w[D].Value[C].BGValue):N++;N==w[D].Value.length?K=0!=D?w[D-1].AverageBGValue:0:K/=w[D].Value.length,w[D].AverageBGValue=K,K>J&&(J=K),K=0}180>J&&(J=180);var Q=d3.time.format("%m/%e/%y").parse;xTopGraphScale=d3.time.scale().domain([Q(w[0].Date),Q(w[w.length-1].Date)]).range([0,a]),yTopGraphScale=d3.scale.linear().domain([0,J]).rangeRound([e.top/2,0]),xTopAxis=d3.svg.axis().scale(xTopGraphScale).orient("bottom").ticks(8),l.append("g").attr("class","axis topAxis").attr("transform","translate("+e.left+","+e.top/4+")").transition().duration(500).call(xTopAxis);var W,X=Q(w[w.length-1].Date);W=Q(w.length>14?w[w.length-14].Date:w[0].Date),brush=d3.svg.brush().x(xTopGraphScale).extent([W,X]).on("brush",G);var Z=l.append("g").attr("class","x brush").attr("transform","translate("+e.left+","+e.top/2+")"),_=Z.append("svg:circle").attr("r",7).attr("cx",150).attr("cy",25).attr("fill","#676767"),tt=Z.append("svg:circle").attr("r",7).attr("cx",175).attr("cy",25).attr("fill","#676767");Z.call(brush),Z.selectAll("rect").attr("y",-4).attr("height",58).attr("opacity",.2),Z.selectAll(".resize.e rect").attr("width",25).attr("x",-5),Z.selectAll(".resize.w rect").attr("width",25).attr("x",-5),G(),l.append("line").attr("x1",e.left).attr("y1",yTopGraphScale(70)+e.top/2).attr("x2",e.left+a).attr("y2",yTopGraphScale(70)+e.top/2).attr("stroke-width",2).attr("stroke","#b2d1dc").attr("stroke-dasharray","3, 3"),l.append("line").attr("x1",e.left).attr("y1",yTopGraphScale(180)+e.top/2).attr("x2",e.left+a).attr("y2",yTopGraphScale(180)+e.top/2).attr("stroke-width",2).attr("stroke","#b2d1dc").attr("stroke-dasharray","3, 3");var et=d3.svg.line().interpolate("basis").x(function(t){return xTopGraphScale(Q(t.Date))}).y(function(t){return yTopGraphScale(t.AverageBGValue)}),at=l.append("path").datum(w).attr("d",function(t){return et(t)}).attr("transform","translate("+e.left+", "+e.top/2+")").attr("stroke","#000000").attr("stroke-width",2).attr("fill","none")})}var e={top:110,bottom:30,left:50,right:200},a=1100-e.left-e.right,r=650-e.top-e.bottom,l=d3.select("div#svg").append("svg").attr("width",a+e.left+e.right).attr("height",r+e.top+e.bottom),o=d3.select("#svg").append("div").attr("class","tooltip").style("opacity",0),n,i,s,p,c=d3.time.format("%I:%M:%S %p").parse,u="#ffc907",h="#a7a9ac",d="#88b5e1",g="#75a6d8",f="#8084c0",y="#d6d7d9",v=100;t(1),$(".btn").click(function(e){d3.selectAll("svg > *").remove();var a=$(this).attr("data");$(".btn-primary").removeClass("btn-primary"),$(this).addClass("btn-primary"),t(a)})});